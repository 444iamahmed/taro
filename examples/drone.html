<!DOCTYPE html>
<html lang='en'>
	<head>
		<meta charset='UTF-8' />
		<meta name='viewport' content='width=device-width,initial-scale=1' />
		<title>Drone</title>
		<link rel="shortcut icon" href="../files/favicon.ico" />
		<style>
			html,
			body {
				margin: 0;
				height: 100%;
			}

			#canvas {
				width: 100%;
				height: 100%;
			}
		</style>
	</head>
	<body>
		<canvas id='canvas'></canvas>
		<script type='module'>
			import * as TARO from '../build/taro.module.js';
			import { OrbitControls } from './js/OrbitControls.js';

			// app setup
			let entity, geo, mat, mesh;

			const app = new TARO.App({
				canvas: document.getElementById('canvas'),
				antialias: true
			});
			const scene = new TARO.Scene();
			app.setScene(scene);
			scene.background = new TARO.Color( 0xe0e0e0 );

			// lighting
			entity = new TARO.Entity();
			entity.addComponent('light', {type: 'hemisphere', intensity: 0.6});
			entity.position.set(0, 100, 0);

			entity = new TARO.Entity();
			entity.addComponent('light', {type: 'directional'});
			entity.position.set(-100, 175, 100);

			// skybox
			const loader = new TARO.TextureLoader();

			// load a resource
			const texture = loader.load('textures/terrain.jpg', ( texture ) => {
				const textureEquirect = new TARO.WebGLCubeRenderTarget( texture.image.height );
				textureEquirect.fromEquirectangularTexture( app.renderer, texture );
				scene.background = textureEquirect.texture;
			});

			// camera
			entity = new TARO.Entity('camera');
			const camera = entity.addComponent('camera').ref;
			camera.position.set(0.5, 0.5, 0.5);
			const controls = new OrbitControls( camera, app.renderer.domElement );
			controls.maxPolarAngle = Math.PI * 0.5;

			// drone constants
			const mass = 1.380;
			const gravity = 9.80665;
			const defaultRotorForce = mass*gravity/4;

			// components
			TARO.registerComponent('droneControls', class {

				init() {
					this.rigidbody = this.entity.getComponent('rigidbody').ref;
					this.fl = new TARO.Vector3();
					this.fr = new TARO.Vector3();
					this.bl = new TARO.Vector3();
					this.br = new TARO.Vector3();
					this.vector = new TARO.Vector3();

					const parts = this.entity.getComponent('renderable').ref.children;
					this.fans = [parts[30], parts[31], parts[32], parts[33]];

				}

				update( delta ) {

					const rotation = delta * 40;

					this.fans[0].rotateZ( rotation );
					this.fans[1].rotateZ( -rotation );
					this.fans[2].rotateZ( rotation );
					this.fans[3].rotateZ( -rotation );

				}

				fixedUpdate() {

					const input = this.app.input;

					this.fl.set(0, defaultRotorForce, 0);
					this.fr.set(0, defaultRotorForce, 0);
					this.bl.set(0, defaultRotorForce, 0);
					this.br.set(0, defaultRotorForce, 0);

					console.log(this.fl)

					// throttle up
					if (input.getKey('KeyW')) {
						this.fl.y += 0.25;
						this.fr.y += 0.25;
						this.bl.y += 0.25;
						this.br.y += 0.25;
					}

					// throttle down
					if (input.getKey('KeyS')) {

					}

					// yaw left
					if (input.getKey('KeyA')) {

					}

					// yaw right
					if (input.getKey('KeyD')) {

					}

					// pitch up
					if (input.getKey('KeyI')) {

					}

					// pitch down
					if (input.getKey('KeyK')) {

					}

					// roll left
					if (input.getKey('KeyJ')) {

					}

					// roll right
					if (input.getKey('KeyL')) {

					}

					this.rigidbody.applyForce( this.fl, this.vector.set(0.08483705296, 0, 0.12714576065) );
					this.rigidbody.applyForce( this.fr, this.vector.set(-0.08483705296, 0, 0.12714576065) );
					this.rigidbody.applyForce( this.bl, this.vector.set(0.08483705296, 0, -0.12714576065) );
					this.rigidbody.applyForce( this.br, this.vector.set(-0.08483705296, 0, -0.12714576065) );

				}

			});

			TARO.registerComponent('followDrone', class FollowDrone {

				init() {
					this.drone = scene.getEntityByName('drone');
					this.oldPosition = new TARO.Vector3();
					this.newPosition = new TARO.Vector3();
					this.offset = new TARO.Vector3();
				}

				update( delta ) {

					// this.newPosition.copy(this.drone.position);
					// this.offset.subVectors(this.newPosition, this.oldPosition);

					// entity.position.add(this.offset);
					// controls.update();

					// this.oldPosition.copy(this.newPosition);
				}

			});

			const objectLoader = new TARO.ObjectLoader();
			objectLoader.load( "models/drone.json", ( obj ) => {

					// drone
					obj.scale.multiplyScalar(0.00271157519);

					const drone = new TARO.Entity('drone');
					drone.addComponent('renderable', obj);
					drone.addComponent('rigidbody', {
						type: 'dynamic',
						mass: mass
					})
					drone.addComponent('shape', {
						type: 'box',
						halfExtents: new TARO.Vector3(0.14475, 0.098, 0.14475)
					})
					drone.addComponent('droneControls')

					entity.addComponent('followDrone');

					controls.target = entity.position;
					controls.update();

				}
			);

			// start the app
			app.start();

		</script>
	</body>
</html>
