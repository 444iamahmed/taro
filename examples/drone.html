<!DOCTYPE html>
<html lang='en'>
	<head>
		<meta charset='UTF-8' />
		<meta name='viewport' content='width=device-width,initial-scale=1' />
		<title>Drone</title>
		<style>
			html,
			body {
				margin: 0;
				height: 100%;
			}

			#canvas {
				width: 100%;
				height: 100%;
			}
		</style>
	</head>
	<body>
		<canvas id='canvas'></canvas>
		<script type='module'>
			import * as TARO from '../build/taro.module.js';
			import { OrbitControls } from './js/OrbitControls.js'

			// app setup
			let entity, geo, mat, mesh;

			const app = new TARO.App({
				canvas: document.getElementById('canvas'),
				antialias: true
			});
			const scene = new TARO.Scene();
			app.setScene(scene);
			scene.background = new TARO.Color( 0xe0e0e0 );

			// lighting
			entity = new TARO.Entity();
			entity.addComponent('light', {type: 'hemisphere', intensity: 0.6});
			entity.position.set(0, 100, 0);

			entity = new TARO.Entity();
			entity.addComponent('light');
			entity.position.set(-100, 175, 100);

			// skybox
			const loader = new TARO.TextureLoader();

			// load a resource
			loader.load('textures/terrain.jpg', ( texture ) => {
					const textureEquirect = new TARO.WebGLCubeRenderTarget( texture.image.height );
					textureEquirect.fromEquirectangularTexture( app.renderer, texture );
					scene.background = textureEquirect;
				}
			);

			// camera
			entity = new TARO.Entity('camera');
			const camera = entity.addComponent('camera').ref;
			camera.position.set(0.5, 0.5, 0.5);
			const controls = new OrbitControls( camera, app.renderer.domElement );
			controls.maxPolarAngle = Math.PI * 0.5;

			// components
			TARO.registerComponent('droneControls', class DroneControls {

				init() {
					this.rigidbody = this.entity.getComponent('rigidbody').ref;
					this.vector = new TARO.Vector3();
					this.vector2 = new TARO.Vector3();

					const parts = this.entity.getComponent('renderable').ref.children;
					this.fans = [parts[30], parts[31], parts[32], parts[33]];
				}

				update( delta ) {

					const rotation = delta * 40;

					this.fans[0].rotateZ( rotation );
					this.fans[1].rotateZ( -rotation );
					this.fans[2].rotateZ( rotation );
					this.fans[3].rotateZ( -rotation );

				}

				fixedUpdate() {

					this.vector.set(0, -this.rigidbody.velocity.y, 0);
					this.vector.y += 9.80665
					this.vector.multiplyScalar(1.380);
					this.vector.applyQuaternion(this.entity.quaternion);

					this.rigidbody.applyForce(this.vector);

					this.rigidbody.force.copy(this.vector.copy(this.rigidbody.force).clampLength(-35, 35))

					const input = this.app.input;

					if (input.getKey('KeyW')) {
						this.vector.set(0, 1, 0)
						this.rigidbody.applyForce( this.vector )
					}

					if (input.getKey('KeyS')) {
						this.vector.set(0, -1, 0)
						this.rigidbody.applyForce( this.vector )
					}

					if (input.getKey('KeyA')) {
						this.vector.set(0.001, 0, 0)
						this.vector2.set(0, 0, -100)
						this.rigidbody.applyLocalForce( this.vector, this.vector2 )
					}

					if (input.getKey('KeyD')) {
						this.vector.set(0.001, 0, 0)
						this.vector2.set(0, 0, 100)
						this.rigidbody.applyLocalForce( this.vector, this.vector2 )
					}

					if (input.getKey('KeyI')) {
						this.vector.set(0, -0.0001, 0)
						this.vector2.set(0, 0, 100)
						this.rigidbody.applyLocalForce( this.vector, this.vector2 )
					}

					if (input.getKey('KeyK')) {
						this.vector.set(0, 0.0001, 0)
						this.vector2.set(0, 0, 100)
						this.rigidbody.applyLocalForce( this.vector, this.vector2 )
					}

					if (input.getKey('KeyJ')) {
						this.vector.set(0, 0.0001, 0)
						this.vector2.set(100, 0, 0)
						this.rigidbody.applyLocalForce( this.vector, this.vector2 )
					}

					if (input.getKey('KeyL')) {
						this.vector.set(0, -0.0001, 0)
						this.vector2.set(100, 0, 0)
						this.rigidbody.applyLocalForce( this.vector, this.vector2 )
					}

				}

			});

			TARO.registerComponent('followDrone', class FollowDrone {

				init() {
					this.drone = scene.getEntityByName('drone');
					this.oldPosition = new TARO.Vector3();
					this.newPosition = new TARO.Vector3();
					this.offset = new TARO.Vector3();
				}

				update( delta ) {

					// this.newPosition.copy(this.drone.position);
					// this.offset.subVectors(this.newPosition, this.oldPosition);

					// entity.position.add(this.offset);
					// controls.update();

					// this.oldPosition.copy(this.newPosition);
				}

			});

			const objectLoader = new TARO.ObjectLoader();
			objectLoader.load( "models/drone.json", ( obj ) => {

					// drone
					obj.scale.set(0.00271157519, 0.00271157519, 0.00271157519);

					const drone = new TARO.Entity('drone');
					drone.addComponent('renderable', obj);
					drone.addComponent('rigidbody', {
						type: 'dynamic',
						mass: 1.380
					})
					drone.addComponent('shape', {
						type: 'box',
						halfExtents: new TARO.Vector3(0.14475, 0.098, 0.14475)
					})
					drone.addComponent('droneControls')

					entity.addComponent('followDrone');

					controls.target = entity.position;
					controls.update();

				}
			);

			// start the app
			app.start();

		</script>
	</body>
</html>
